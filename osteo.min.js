!function(){window.Osteo={TEMPLATES:{},TRANSLATIONS:{},VERSION:"0.1.0"}}(),function(){Osteo.Cache=function(){this.cache={}},Osteo.Cache.prototype={add:function(a){a.model&&(this.cache[a.model.cid]=a),this.cache[a.cid]=a},get:function(a){return a.cid?this.cache[a.cid]:this.cache[a]},remove:function(a){void 0!==a.model&&delete this.cache[a.model.cid],delete this.cache[a.cid]},cached:function(){return _.uniq(_.values(this.cache))}}}(),function(){Osteo.Collection=Backbone.Collection.extend({initialize:function(a,b){b||(b={}),this.root=b.root},parse:function(a){return this.root?a[this.root]:a},toPresenters:function(a){return a||(a=Osteo.Presenter),this.map(function(b){return new a(b)})}})}(),function(){Osteo.Model=Backbone.Model.extend({defaultAutoSaveDelay:500,initialize:function(){this.autoSaveDelay=this.defaultAutoSaveDelay},autoSave:function(){return this.debouncedSave||(this.debouncedSave=_.debounce(this.save,this.autoSaveDelay)),this.debouncedSave(),!0}})}(this),function(){Osteo.Presenter=function(a){this.model=a,this.model.on("change",this.replicate,this),this.replicate(a)},Osteo.Presenter.prototype={get:function(a){return this.model.get(a)},replicate:function(a){var b=_.isEmpty(a.changed)?a.attributes:a.changed;for(var c in b)_.isFunction(this[c])||(this[c]=b[c])}}}(),function(){Osteo.View=Backbone.View.extend({lazyRenderDelay:50,initialize:function(a){this.options=a||{},this.lazyRenderDelay=a.lazyRenderDelay||this.lazyRenderDelay,a.presenter&&(this.presenter=a.presenter),a.template&&(this.template=a.template),a.disableBoundRendering!==!0&&Osteo.BoundRenderer.extend(this)},isRendered:function(){return!!this._rendered},afterRender:function(){},bindEvents:function(){return this},unbindEvents:function(){return this.undelegateEvents(),this},render:function(){return this._rendered=!0,this.template&&this.$el.html(this.renderTemplate(this.template,this.renderContext())),this.afterRender.call(this),this},lazyRender:function(){return this.debouncedRender||(this.debouncedRender=_.debounce(this.render,this.lazyRenderDelay)),this.debouncedRender(),this},renderTemplate:function(a,b){return this._lookupTemplate(a)(b)},renderContext:function(){return this.presenter?this.presenter:this.model?this.model.attributes:{}},show:function(){return this.isRendered()||this.render(),this.$el.removeClass("hide"),this},hide:function(){return this.isRendered()&&this.$el.addClass("hide"),this},destroy:function(a){return this.hide(),this.unbindEvents(),this.remove(),a&&a.complete&&this.model.destroy(),this},_lookupTemplate:function(a){var b=Osteo.TEMPLATES[a];if(!b)throw new Error("No such template: "+a);return b}})}(),function(){Osteo.I18n={pattern:/%\{(.+?)\}/g,lookup:function(a,b){var c=b?b.hash||b:{},d=_.reduce(a.split("."),function(a,b){return a[b]},Osteo.TRANSLATIONS);return d.replace(Osteo.I18n.pattern,function(a,b){return c[b]})}}}(),function(){Osteo.BoundRenderer={extend:function(a){a.boundRender=this.boundRender,a.boundElements={},a.model&&a.model.on&&a.listenTo(a.model,"change",a.boundRender)},boundRender:function(a){var b,c;for(var d in a.changed)this.boundElements[d]?b=this.boundElements[d]:(b=this.$("[data-bind="+d+"]"),this.boundElements[d]=b),c=this.presenter?this.presenter[d]:a.changed[d],b.length&&b.text(c)}}}(),function(){Osteo.CollectionView=Osteo.View.extend({viewClass:Osteo.View,initialize:function(a){Osteo.View.prototype.initialize.call(this,a),a.selector&&(this.selector=a.selector),a.viewClass&&(this.viewClass=a.viewClass),this.collection&&(this.listenTo(this.collection,"add",this.addView),this.listenTo(this.collection,"destroy",this.modelDestroyed),this.listenTo(this.collection,"reset",this.reset),this.listenTo(this.collection,"sort",this.sort)),this.viewCache=new Osteo.Cache},container:function(){return this._container||(this._container=this.selector?this.$(this.selector):this.$el),this._container},addView:function(a,b){var c,d,e=this.getView(a).show(),f=this.collection.indexOf(a);0===f?this.container().prepend(e.$el):(c=b.at(f-1),d=this.getView(c),d.$el.after(e.$el))},appendView:function(a){var b=this.getView(a).show().$el;this.container().append(b)},getView:function(a){var b=this.viewCache.get(a);return b||(b=new this.viewClass({model:a}),this.viewCache.add(b)),b},render:function(){return Osteo.View.prototype.render.call(this),this.reset(),this},renderContext:function(){return this.collection},reset:function(){return this.container().empty(),this.collection.each(this.appendView,this),this},sort:function(){var a=this.container(),b=this.viewCache;_.each(this.viewCache.cached(),function(a){a.$el.detach()}),this.collection.each(function(c){a.append(b.get(c).$el)})},modelDestroyed:function(a){var b=this.getView(a);this.viewCache.remove(a),b.destroy()}})}(),function(){Osteo.ModalView=Osteo.View.extend({className:"osteo-modal js-osteo-modal",rootSelector:"body",screenTemplate:"<div class='osteo-screen js-osteo-screen'></div>",events:{"click .js-cancel":"cancel","click .js-return":"cancel"},display:function(a){return a||(a={}),this.model=a.model,this.presenter=a.presenter,this.collection=a.collection,this.render(),this.open(),this},open:function(){this.appendBody(),this.appendScreen()},cancel:function(){return this.hide(),this.hideScreen(),!1},hideScreen:function(){this.$screen&&this.$screen.addClass("hide")},appendBody:function(){this.$el.appendTo(this.rootSelector).removeClass("hide")},appendScreen:function(){this.$screen||(this.$screen=$(this.screenTemplate)),this.$screen.appendTo(this.rootSelector).off("click.osteo").on("click.osteo",this.cancel).removeClass("hide")}})}();
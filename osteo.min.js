!function(a,b){"use strict";a.Osteo={TEMPLATES:{},TRANSLATIONS:{},VERSION:"0.5.1"},Osteo.Cache=function(){this.cache={}},Osteo.Cache.prototype={add:function(a){a.model&&(this.cache[a.model.cid]=a),this.cache[a.cid]=a},get:function(a){return a.cid?this.cache[a.cid]:this.cache[a]},remove:function(a){a.model!==b&&delete this.cache[a.model.cid],delete this.cache[a.cid]},cached:function(){return _.uniq(_.values(this.cache))}},Osteo.Collection=Backbone.Collection.extend({initialize:function(a,b){b=b||{},b.root&&(this.root=b.root)},parse:function(a){return this.root?(this.associateRelations(a,this.root),a[this.root]):a},add:function(){var a,b;return b=Backbone.Collection.prototype.add.apply(this,arguments),this.root&&(a=Osteo.Sideload.singularize(this.root),this.each(function(b){b.root=a})),b},toPresenters:function(a){return a||(a=Osteo.Presenter),this.map(function(b){return new a(b)})},associateRelations:function(a,b){return Osteo.Sideload.associate(a,b)}}),Osteo.Model=Backbone.Model.extend({defaultAutoSaveDelay:500,relations:{},root:null,initialize:function(){this.autoSaveDelay=this.defaultAutoSaveDelay},parse:function(a){return this.root?a[this.root]||a:a},set:function(a){return this.attachRelations(a),Backbone.Model.prototype.set.apply(this,arguments)},autoSave:function(){return this.debouncedSave||(this.debouncedSave=_.debounce(this.save,this.autoSaveDelay)),this.debouncedSave(),!0},attachRelations:function(a){var b,c,d=this.relations;_.isFunction(d)&&(d=d.call(this));for(var e in d)b=a[e],c=d[e],this[e]=new c(b),delete a[e];return a}}),Osteo.Presenter=function(a){this.model=a,this.model.on("change",this.replicate,this),this.replicate(a)},Osteo.Presenter.prototype={get:function(a){return this.model.get(a)},replicate:function(a){var b=_.isEmpty(a.changed)?a.attributes:a.changed;for(var c in b)_.isFunction(this[c])||(this[c]=b[c]);return!0}},Osteo.Route=function(){},Osteo.Route.prototype={load:function(){return this},unload:function(){return this}},Osteo.Router=Backbone.Router.extend({handlers:{},initialize:function(){this.on("route",this.handle,this)},handle:function(a,b){var c,d=_.isFunction(this.handlers)?this.handlers():this.handlers,e=d[a];return this.lastRoute&&this.lastRoute.unload(),e&&(c=this._getRouteInstance(e),c.load(b)),this.lastRoute=c,c},pathFor:function(a,b){var c=_.invert(this.routes),d=c[a];if(b=b?b.attributes||b:{},!d)throw new Error("No such path name: "+a);return d.replace(/:(.+?)(\/|$)/g,function(a,c,d){return b[c]+d})},visit:function(a,b){var c=this.pathFor(a,b);this.navigate(c,{trigger:!0})},_getRouteInstance:function(a){var b;return a.instance||(b=new a,a.instance=function(){return b}),a.instance()}}),Osteo.View=Backbone.View.extend({lazyRenderDelay:50,initialize:function(a){a||(a={}),this.options=a,this.lazyRenderDelay=a.lazyRenderDelay||this.lazyRenderDelay,a.context&&(this.context=a.context),a.boundRendering&&Osteo.BoundRenderer.extend(this)},context:function(){return this.model?this.model.attributes:{}},isRendered:function(){return!!this._rendered},beforeRender:function(){},afterRender:function(){},bindEvents:function(){return this},unbindEvents:function(){return this.undelegateEvents(),this},render:function(){var a;return this.beforeRender.call(this),this._rendered=!0,this.template&&(a=_.isFunction(this.context)?this.context.call(this):this.context,this.$el.html(this.renderTemplate(this.template,a))),_.defer(_.bind(this.afterRender,this)),this},lazyRender:function(){return this.debouncedRender||(this.debouncedRender=_.debounce(this.render,this.lazyRenderDelay)),this.debouncedRender(),this},renderTemplate:function(a,b){return this._lookupTemplate(a)(b)},show:function(){return this.isRendered()||this.render(),this.$el.removeClass("hide"),this},hide:function(){return this.isRendered()&&this.$el.addClass("hide"),this},destroy:function(a){return this.hide(),this.unbindEvents(),this.remove(),a&&a.complete&&this.model.destroy(),this},_lookupTemplate:function(a){var b=Osteo.TEMPLATES[a];if(!b)throw new Error("No such template: "+a);return b}}),Osteo.I18n={pattern:/%\{(.+?)\}/g,lookup:function(a,b){var c=b?b.hash||b:{},d=_.reduce(a.split("."),function(a,b){return a[b]},Osteo.TRANSLATIONS);return d.replace(Osteo.I18n.pattern,function(a,b){return c[b]})}},Osteo.Sideload={associate:function(a,b){var c=this._relKeys(a,b),d=this._findRelations,e=a[b],f=this;return _.isArray(e)||(e=[e]),_.map(e,function(b){for(var e in c)b[e]=d.call(f,a[e],c[e],b);return b})},singularize:function(a){return a.replace(/s$/,"")},_relKeys:function(a,b){var c={};for(var d in a)d!==b&&(c[d]=this.singularize(d));return c},_findRelations:function(a,b,c){var d=this._idKey(b,c),e=c[d];return _.isArray(e)||(e=[e]),_.map(e,function(b){return _.find(a,function(a){return a.id===b})})},_idKey:function(a,b){var c=a+"_ids";return b[c]?c:a+"_id"}},Osteo.BoundRenderer={extend:function(a){a.boundElements={},a.boundRender=this.boundRender,a.context||(a.context=function(){return a.model.attributes}),a.model&&a.listenTo(a.model,"change",function(a){this.boundRender(a.changed)})},boundRender:function(a){var b,c;for(var d in a)this.boundElements[d]?b=this.boundElements[d]:(b=this.$("[data-bind="+d+"]"),this.boundElements[d]=b),c=this.context()[d],b.length&&b.text(c)}},Osteo.CollectionView=Osteo.View.extend({viewClass:Osteo.View,initialize:function(a){Osteo.View.prototype.initialize.call(this,a),a.selector&&(this.selector=a.selector),a.viewClass&&(this.viewClass=a.viewClass),this.collection&&(this.listenTo(this.collection,"add",this.addView),this.listenTo(this.collection,"destroy",this.modelDestroyed),this.listenTo(this.collection,"reset",this.reset),this.listenTo(this.collection,"sort",this.sort)),this.viewCache=new Osteo.Cache},container:function(){return this._container||(this._container=this.selector?this.$(this.selector):this.$el),this._container},addView:function(a,b){var c,d,e=this.getView(a).show(),f=this.collection.indexOf(a);0===f?this.container().prepend(e.$el):(c=b.at(f-1),d=this.getView(c),d.$el.after(e.$el))},getView:function(a){var b=this.viewCache.get(a);return b||(b=new this.viewClass({model:a}),this.viewCache.add(b)),b},renderContext:function(){return this.collection},reset:function(){this.isRendered()||this.render();var a=this.collection.map(function(a){return this.getView(a).show().$el},this);return this.container().html(a),this},sort:function(){var a=this.container(),b=this.viewCache;_.each(this.viewCache.cached(),function(a){a.$el.detach()}),this.collection.each(function(c){a.append(b.get(c).$el)})},modelDestroyed:function(a){var b=this.getView(a);this.viewCache.remove(a),b.destroy()}}),Osteo.ModalView=Osteo.View.extend({className:"modal-view js-osteo-modal",rootSelector:"body",screenTemplate:"<div class='modal-screen js-osteo-screen'></div>",events:{"click .js-cancel":"cancel"},display:function(a){return a||(a={}),this.collection=a.collection,this.context=a.context,this.model=a.model,this.render(),this.open(),this},open:function(){this.appendBody(),this.appendScreen()},cancel:function(){return this.hide(),this.hideScreen(),!1},hideScreen:function(){this.$screen&&this.$screen.addClass("hide")},appendBody:function(){this.$el.appendTo(this.rootSelector).removeClass("hide")},appendScreen:function(){this.$screen||(this.$screen=$(this.screenTemplate)),this.$screen.appendTo(this.rootSelector).off("click.osteo").on("click.osteo",this.cancel).removeClass("hide")}})}(window);